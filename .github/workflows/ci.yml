name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Lint JavaScript/TypeScript
        run: pnpm lint:js
      
      - name: Lint CSS
        run: pnpm lint:css
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer
      
      - name: Install PHP dependencies
        run: composer install --working-dir=packages/plugin
      
      - name: Lint PHP
        run: pnpm lint:php

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: TypeScript Check
        run: pnpm type-check
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer
      
      - name: Install PHP dependencies
        run: composer install --working-dir=packages/plugin
      
      - name: PHPStan Analysis
        run: cd packages/plugin && composer analyse

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run Unit Tests
        run: pnpm test:unit
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer
      
      - name: Install PHP dependencies
        run: composer install --working-dir=packages/plugin
      
      - name: Run PHP Tests
        run: cd packages/plugin && composer test

  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [lint, type-check, test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build all packages
        run: pnpm build
      
      - name: Upload Plugin Build
        uses: actions/upload-artifact@v3
        with:
          name: plugin-build
          path: builds/cloudstudio-elementor-widgets-*.zip
      
      - name: Upload Theme Build
        uses: actions/upload-artifact@v3
        with:
          name: theme-build
          path: builds/cloudstudio-hello-child-*.zip

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Install Playwright
        run: npx playwright install --with-deps
      
      - name: Run E2E Tests
        run: pnpm test:e2e
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, e2e]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.cloud.studio
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Plugin Build
        uses: actions/download-artifact@v3
        with:
          name: plugin-build
          path: builds/
      
      - name: Download Theme Build
        uses: actions/download-artifact@v3
        with:
          name: theme-build
          path: builds/
      
      - name: Deploy to Staging
        run: echo "Deploy to staging would happen here"
        # Add your deployment script here

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, e2e]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://cloud.studio
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Plugin Build
        uses: actions/download-artifact@v3
        with:
          name: plugin-build
          path: builds/
      
      - name: Download Theme Build
        uses: actions/download-artifact@v3
        with:
          name: theme-build
          path: builds/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: builds/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy to Production
        run: echo "Deploy to production would happen here"
        # Add your deployment script here
